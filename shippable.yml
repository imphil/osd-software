language: c

compiler:
  - gcc
  - clang

build:
  ci:
    # Build and install GLIP as build dependency
    - git clone --depth 1 https://github.com/TUM-LIS/glip.git
    - cd glip && ./autogen.sh && ./configure --prefix=$PWD/../glip-install && make && make install && cd ..
    - export PKG_CONFIG_PATH=$PWD/glip-install/lib/pkgconfig

    # Now build the actual OSD software
    - ./install-build-deps.sh
    - ./autogen.sh
    - ./configure --enable-debug --enable-code-coverage --enable-valgrind
    - make
    - make check-code-coverage
    - make check-valgrind

    # Copy test results where shippable.io finds them
    - make -C tests/unit check-junit-xml
    - cp tests/unit/*.junit.xml shippable/testresults

    # Copy code coverage information where shippable.io finds it
    - make -C tests/unit coverage-cobertura-xml
    - cp tests/unit/coverage-cobertura.xml shippable/codecoverage

  on_success:
    - bash <(curl -s https://codecov.io/bash)
